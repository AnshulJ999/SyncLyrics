name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0.0, v2.1.3, etc.
  workflow_dispatch:
    inputs:
      tag:
        description: 'Version tag to build (e.g., v1.9.0)'
        required: true
        type: string
      debug_build:
        description: 'Build with console window (debug mode)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

env:
  PYTHON_VERSION: '3.12'

jobs:
  # ============================================
  # Prepare: Validate and extract version info
  # ============================================
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      version_clean: ${{ steps.version.outputs.version_clean }}
      prerelease: ${{ steps.version.outputs.prerelease }}
    steps:
      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.tag }}"
            echo "Using manual tag: $VERSION"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
            echo "Using git tag: $VERSION"
          fi
          
          # Validate version format
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            echo "::error::Invalid version format: $VERSION (expected v*.*.* format)"
            exit 1
          fi
          
          # Clean version (without 'v' prefix)
          VERSION_CLEAN="${VERSION#v}"
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_clean=$VERSION_CLEAN" >> $GITHUB_OUTPUT
          
          # Check if prerelease (beta, alpha, rc)
          if [[ "$VERSION" =~ (beta|alpha|rc) ]]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
            echo "Detected prerelease tag"
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
          fi

  # ============================================
  # Windows Build
  # ============================================
  build-windows:
    needs: prepare
    runs-on: windows-latest
    outputs:
      smoke_test: ${{ steps.smoke.outputs.smoke_test }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set version from tag
        shell: pwsh
        run: |
          "VERSION = `"${{ needs.prepare.outputs.version_clean }}`"" | Out-File -FilePath version.py -Encoding utf8
          Write-Host "Version set to: ${{ needs.prepare.outputs.version_clean }}"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build executable
        run: |
          if ("${{ github.event.inputs.debug_build }}" -eq "true") {
            python build.py --debug
          } else {
            python build.py
          }

      - name: Create ZIP archive
        shell: pwsh
        run: |
          cd build_final
          Compress-Archive -Path SyncLyrics -DestinationPath "../SyncLyrics-${{ needs.prepare.outputs.version }}-windows-x64.zip"

      - name: Generate checksum
        shell: pwsh
        run: |
          $hash = Get-FileHash "SyncLyrics-${{ needs.prepare.outputs.version }}-windows-x64.zip" -Algorithm SHA256
          "$($hash.Hash.ToLower())  SyncLyrics-${{ needs.prepare.outputs.version }}-windows-x64.zip" | Out-File -FilePath "checksum-windows.txt" -Encoding utf8 -NoNewline

      - name: Smoke test
        id: smoke
        shell: pwsh
        run: |
          Write-Host "Starting smoke test..."
          $proc = Start-Process -FilePath "build_final\SyncLyrics\SyncLyrics.exe" -PassThru -WindowStyle Hidden
          Start-Sleep -Seconds 15
          try {
            $response = Invoke-WebRequest -Uri "http://localhost:9012/health" -TimeoutSec 5 -UseBasicParsing
            if ($response.StatusCode -eq 200) {
              Write-Host "âœ… Health check passed! Server started successfully."
              echo "smoke_test=passed" >> $env:GITHUB_OUTPUT
            } else {
              Write-Host "âš ï¸ Health check returned status: $($response.StatusCode)"
              echo "smoke_test=warning" >> $env:GITHUB_OUTPUT
            }
          } catch {
            Write-Host "âŒ Health check failed: $_"
            echo "smoke_test=failed" >> $env:GITHUB_OUTPUT
          } finally {
            Stop-Process -Id $proc.Id -Force -ErrorAction SilentlyContinue
          }

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: |
            SyncLyrics-${{ needs.prepare.outputs.version }}-windows-x64.zip
            checksum-windows.txt

  # ============================================
  # Linux Build
  # ============================================
  build-linux:
    needs: prepare
    runs-on: ubuntu-latest
    outputs:
      smoke_test: ${{ steps.smoke.outputs.smoke_test }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set version from tag
        run: |
          echo "VERSION = \"${{ needs.prepare.outputs.version_clean }}\"" > version.py
          echo "Version set to: ${{ needs.prepare.outputs.version_clean }}"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libasound2-dev \
            libportaudio2 \
            portaudio19-dev \
            libffi-dev \
            fuse \
            libfuse2

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          # Remove Windows-only packages from requirements before installing
          grep -v -E "^(winsdk|pywin32|pystray|desktop-notifier)" requirements.txt > requirements_linux.txt
          pip install -r requirements_linux.txt
          pip install pyinstaller

      - name: Build with PyInstaller
        run: python build.py

      - name: Create tarball
        run: |
          cd build_final
          tar -czvf "../SyncLyrics-${{ needs.prepare.outputs.version }}-linux-x64.tar.gz" SyncLyrics

      - name: Create AppImage
        run: |
          # Download linuxdeploy
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage
          
          # Create AppDir structure
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          
          # Copy built files
          cp -r build_final/SyncLyrics/* AppDir/usr/bin/
          
          # Copy desktop file and icon
          cp resources/linux/synclyrics.desktop AppDir/usr/share/applications/
          cp resources/images/icon.png AppDir/usr/share/icons/hicolor/256x256/apps/synclyrics.png
          
          # Create AppImage
          ARCH=x86_64 ./linuxdeploy-x86_64.AppImage \
            --appdir AppDir \
            --desktop-file resources/linux/synclyrics.desktop \
            --icon-file resources/images/icon.png \
            --output appimage || true
          
          # Rename output (linuxdeploy names it based on desktop file)
          if [ -f SyncLyrics*.AppImage ]; then
            mv SyncLyrics*.AppImage "SyncLyrics-${{ needs.prepare.outputs.version }}-linux-x64.AppImage"
          else
            echo "::warning::AppImage creation failed, only tarball will be available"
          fi

      - name: Generate checksums
        run: |
          sha256sum "SyncLyrics-${{ needs.prepare.outputs.version }}-linux-x64.tar.gz" > checksum-linux.txt
          if [ -f "SyncLyrics-${{ needs.prepare.outputs.version }}-linux-x64.AppImage" ]; then
            sha256sum "SyncLyrics-${{ needs.prepare.outputs.version }}-linux-x64.AppImage" >> checksum-linux.txt
          fi

      - name: Smoke test
        id: smoke
        run: |
          echo "Starting smoke test..."
          cd build_final/SyncLyrics
          ./SyncLyrics &
          APP_PID=$!
          sleep 15
          if curl -sf http://localhost:9012/health > /dev/null 2>&1; then
            echo "âœ… Health check passed! Server started successfully."
            echo "smoke_test=passed" >> $GITHUB_OUTPUT
          else
            echo "âŒ Health check failed - server may not have started"
            echo "smoke_test=failed" >> $GITHUB_OUTPUT
          fi
          kill $APP_PID 2>/dev/null || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: |
            SyncLyrics-${{ needs.prepare.outputs.version }}-linux-x64.tar.gz
            SyncLyrics-${{ needs.prepare.outputs.version }}-linux-x64.AppImage
            checksum-linux.txt
          if-no-files-found: warn

  # ============================================
  # macOS Build (Intel)
  # ============================================
  build-macos-intel:
    needs: prepare
    runs-on: macos-15-intel  # Intel runner
    outputs:
      smoke_test: ${{ steps.smoke.outputs.smoke_test }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set version from tag
        run: |
          echo "VERSION = \"${{ needs.prepare.outputs.version_clean }}\"" > version.py
          echo "Version set to: ${{ needs.prepare.outputs.version_clean }}"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'  # Use 3.11 for macOS - 3.12 has PyInstaller BUNDLE issues
          cache: 'pip'

      - name: Install system dependencies
        run: |
          brew install portaudio

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          # Remove Windows-only packages
          grep -v -E "^(winsdk|pywin32|pystray|desktop-notifier)" requirements.txt > requirements_macos.txt
          pip install -r requirements_macos.txt
          pip install --upgrade pyinstaller

      # No icon conversion needed - shipping as folder, not .app bundle

      - name: Build with PyInstaller
        env:
          VERSION: ${{ needs.prepare.outputs.version_clean }}
        run: python build.py

      - name: Verify build contents
        run: |
          echo "=== Build output structure ==="
          ls -la build_final/SyncLyrics/ | head -20
          echo "=== Checking for encodings ==="
          ls -la build_final/SyncLyrics/encodings/ 2>/dev/null | head -5 || echo "Encodings compiled into exe"

      - name: Add macOS launcher script
        run: |
          # Copy launcher script to build output
          cp resources/macos/start.command build_final/SyncLyrics/
          chmod +x build_final/SyncLyrics/start.command
          chmod +x build_final/SyncLyrics/SyncLyrics
          echo "âœ… Added start.command launcher"

      - name: Create ZIP archive
        run: |
          cd build_final
          zip -r "../SyncLyrics-${{ needs.prepare.outputs.version }}-macos-x64.zip" SyncLyrics

      - name: Generate checksum
        run: |
          shasum -a 256 "SyncLyrics-${{ needs.prepare.outputs.version }}-macos-x64.zip" > checksum-macos-x64.txt

      - name: Smoke test
        id: smoke
        run: |
          echo "Starting smoke test..."
          cd build_final/SyncLyrics
          ./SyncLyrics &
          APP_PID=$!
          sleep 15
          if curl -sf http://localhost:9012/health > /dev/null 2>&1; then
            echo "âœ… Health check passed! Server started successfully."
            echo "smoke_test=passed" >> $GITHUB_OUTPUT
          else
            echo "âŒ Health check failed - server may not have started"
            echo "smoke_test=failed" >> $GITHUB_OUTPUT
          fi
          kill $APP_PID 2>/dev/null || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-intel-build
          path: |
            SyncLyrics-${{ needs.prepare.outputs.version }}-macos-x64.zip
            checksum-macos-x64.txt

  # ============================================
  # macOS Build (Apple Silicon)
  # ============================================
  build-macos-arm:
    needs: prepare
    runs-on: macos-14  # Apple Silicon runner
    outputs:
      smoke_test: ${{ steps.smoke.outputs.smoke_test }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set version from tag
        run: |
          echo "VERSION = \"${{ needs.prepare.outputs.version_clean }}\"" > version.py
          echo "Version set to: ${{ needs.prepare.outputs.version_clean }}"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'  # Use 3.11 for macOS - 3.12 has PyInstaller BUNDLE issues
          cache: 'pip'

      - name: Install system dependencies
        run: |
          brew install portaudio

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          grep -v -E "^(winsdk|pywin32|pystray|desktop-notifier)" requirements.txt > requirements_macos.txt
          pip install -r requirements_macos.txt
          pip install --upgrade pyinstaller

      # No icon conversion needed - shipping as folder, not .app bundle

      - name: Build with PyInstaller
        env:
          VERSION: ${{ needs.prepare.outputs.version_clean }}
        run: python build.py

      - name: Verify build contents
        run: |
          echo "=== Build output structure ==="
          ls -la build_final/SyncLyrics/ | head -20
          echo "=== Checking for encodings ==="
          ls -la build_final/SyncLyrics/encodings/ 2>/dev/null | head -5 || echo "Encodings compiled into exe"

      - name: Add macOS launcher script
        run: |
          # Copy launcher script to build output
          cp resources/macos/start.command build_final/SyncLyrics/
          chmod +x build_final/SyncLyrics/start.command
          chmod +x build_final/SyncLyrics/SyncLyrics
          echo "âœ… Added start.command launcher"

      - name: Create ZIP archive
        run: |
          cd build_final
          zip -r "../SyncLyrics-${{ needs.prepare.outputs.version }}-macos-arm64.zip" SyncLyrics

      - name: Generate checksum
        run: |
          shasum -a 256 "SyncLyrics-${{ needs.prepare.outputs.version }}-macos-arm64.zip" > checksum-macos-arm64.txt

      - name: Smoke test
        id: smoke
        run: |
          echo "Starting smoke test..."
          cd build_final/SyncLyrics
          ./SyncLyrics &
          APP_PID=$!
          sleep 15
          if curl -sf http://localhost:9012/health > /dev/null 2>&1; then
            echo "âœ… Health check passed! Server started successfully."
            echo "smoke_test=passed" >> $GITHUB_OUTPUT
          else
            echo "âŒ Health check failed - server may not have started"
            echo "smoke_test=failed" >> $GITHUB_OUTPUT
          fi
          kill $APP_PID 2>/dev/null || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm-build
          path: |
            SyncLyrics-${{ needs.prepare.outputs.version }}-macos-arm64.zip
            checksum-macos-arm64.txt

  # ============================================
  # Create Release (consolidates all builds)
  # ============================================
  create-release:
    needs: [prepare, build-windows, build-linux, build-macos-intel, build-macos-arm]
    if: always() && needs.build-windows.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Consolidate checksums
        run: |
          echo "# SyncLyrics ${{ needs.prepare.outputs.version }} - SHA256 Checksums" > checksums.txt
          echo "" >> checksums.txt
          
          # Windows
          if [ -f artifacts/windows-build/checksum-windows.txt ]; then
            echo "## Windows" >> checksums.txt
            cat artifacts/windows-build/checksum-windows.txt >> checksums.txt
            echo "" >> checksums.txt
          fi
          
          # Linux
          if [ -f artifacts/linux-build/checksum-linux.txt ]; then
            echo "## Linux" >> checksums.txt
            cat artifacts/linux-build/checksum-linux.txt >> checksums.txt
            echo "" >> checksums.txt
          fi
          
          # macOS Intel
          if [ -f artifacts/macos-intel-build/checksum-macos-x64.txt ]; then
            echo "## macOS (Intel)" >> checksums.txt
            cat artifacts/macos-intel-build/checksum-macos-x64.txt >> checksums.txt
            echo "" >> checksums.txt
          fi
          
          # macOS ARM
          if [ -f artifacts/macos-arm-build/checksum-macos-arm64.txt ]; then
            echo "## macOS (Apple Silicon)" >> checksums.txt
            cat artifacts/macos-arm-build/checksum-macos-arm64.txt >> checksums.txt
            echo "" >> checksums.txt
          fi
          
          cat checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.version }}
          name: SyncLyrics ${{ needs.prepare.outputs.version }}
          files: |
            artifacts/windows-build/*.zip
            artifacts/linux-build/*.tar.gz
            artifacts/linux-build/*.AppImage
            artifacts/macos-intel-build/*.zip
            artifacts/macos-arm-build/*.zip
            checksums.txt
          generate_release_notes: true
          prerelease: ${{ needs.prepare.outputs.prerelease == 'true' }}
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Summary
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          
          echo "## ðŸš€ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`$VERSION\`" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.prepare.outputs.prerelease }}" == "true" ]; then
            echo "**Type:** âš ï¸ Pre-release" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Type:** âœ… Stable" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Build | Smoke Test | Artifact |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|------------|----------|" >> $GITHUB_STEP_SUMMARY
          
          # Windows
          WIN_SMOKE="${{ needs.build-windows.outputs.smoke_test }}"
          if [ "${{ needs.build-windows.result }}" == "success" ]; then
            if [ "$WIN_SMOKE" == "passed" ]; then
              echo "| Windows x64 | âœ… | âœ… | \`SyncLyrics-$VERSION-windows-x64.zip\` |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Windows x64 | âœ… | âŒ | \`SyncLyrics-$VERSION-windows-x64.zip\` |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Windows x64 | âŒ | â­ï¸ | Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Linux
          LINUX_SMOKE="${{ needs.build-linux.outputs.smoke_test }}"
          if [ "${{ needs.build-linux.result }}" == "success" ]; then
            if [ "$LINUX_SMOKE" == "passed" ]; then
              echo "| Linux x64 | âœ… | âœ… | \`SyncLyrics-$VERSION-linux-x64.tar.gz\` |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Linux x64 | âœ… | âŒ | \`SyncLyrics-$VERSION-linux-x64.tar.gz\` |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Linux x64 | âŒ | â­ï¸ | Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # macOS Intel
          MAC_INTEL_SMOKE="${{ needs.build-macos-intel.outputs.smoke_test }}"
          if [ "${{ needs.build-macos-intel.result }}" == "success" ]; then
            if [ "$MAC_INTEL_SMOKE" == "passed" ]; then
              echo "| macOS Intel | âœ… | âœ… | \`SyncLyrics-$VERSION-macos-x64.zip\` |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| macOS Intel | âœ… | âŒ | \`SyncLyrics-$VERSION-macos-x64.zip\` |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| macOS Intel | âŒ | â­ï¸ | Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # macOS ARM
          MAC_ARM_SMOKE="${{ needs.build-macos-arm.outputs.smoke_test }}"
          if [ "${{ needs.build-macos-arm.result }}" == "success" ]; then
            if [ "$MAC_ARM_SMOKE" == "passed" ]; then
              echo "| macOS Apple Silicon | âœ… | âœ… | \`SyncLyrics-$VERSION-macos-arm64.zip\` |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| macOS Apple Silicon | âœ… | âŒ | \`SyncLyrics-$VERSION-macos-arm64.zip\` |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| macOS Apple Silicon | âŒ | â­ï¸ | Failed |" >> $GITHUB_STEP_SUMMARY
          fi
