<!DOCTYPE html>
<html lang="en" data-bs-theme="{{ theme }}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1db954">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SyncLyrics">
    <!-- Cache control for embedded contexts (Home Assistant iFrame) -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/icon-192.png') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='images/icon.ico')}}" type="image/x-icon">
    <title> SyncLyrics </title>
    <!-- Preload critical CSS for faster first paint -->
    <link rel="preload" href="{{ url_for('static', filename='css/base.css')}}?v={{ cache_version }}" as="style">
    <link rel="preload" href="{{ url_for('static', filename='css/bootstrap.min.css')}}?v={{ cache_version }}" as="style">
    <!-- Preload icon fonts to prevent FOUT (Flash of Unstyled Text) -->
    <link rel="preload" href="{{ url_for('static', filename='css/fonts/bootstrap-icons.woff2')}}" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="{{ url_for('static', filename='css/phosphor/Phosphor-Fill.woff2')}}" as="font" type="font/woff2" crossorigin>
    <!-- Stylesheets -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css')}}?v={{ cache_version }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap-icons.css')}}?v={{ cache_version }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/fonts.css')}}?v={{ cache_version }}">
    <link rel="stylesheet" href="/fonts/custom.css?v={{ cache_version }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css')}}?v={{ cache_version }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/provider.css')}}?v={{ cache_version }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/audio-source.css')}}?v={{ cache_version }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/slideshow.css')}}?v={{ cache_version }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/mediabrowser.css')}}?v={{ cache_version }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/controls.css')}}?v={{ cache_version }}">
    <!-- Phosphor Icons (self-hosted for faster loading) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/phosphor/style.css')}}?v={{ cache_version }}">
    {% block styles %} {% endblock %}
    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js')}}?v={{ cache_version }}" defer></script>
    <script src="{{ url_for('static', filename='js/base.js')}}?v={{ cache_version }}" defer></script>
    {% block scripts %}
    <script>
        function exitApplication(event) {
            event.preventDefault();
            if (confirm('Are you sure you want to exit?')) {
                fetch('/exit-application')
                    .then(response => {
                        if (response.ok) {
                            const notice = document.createElement('div');
                            notice.className = 'alert alert-info position-fixed top-0 start-50 translate-middle-x mt-3';
                            notice.style.zIndex = '9999';
                            notice.innerHTML = 'Application is shutting down...';
                            document.body.appendChild(notice);

                            setTimeout(() => {
                                window.close();
                            }, 2000);
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }
        }

        function restartServer() {
            if (confirm('Are you sure you want to restart the server?')) {
                fetch('/restart', { method: 'POST' })
                    .then(response => {
                        if (response.ok) {
                            const notice = document.createElement('div');
                            notice.className = 'alert alert-info position-fixed top-0 start-50 translate-middle-x mt-3';
                            notice.style.zIndex = '9999';
                            notice.innerHTML = 'Server is restarting. Please wait...';
                            document.body.appendChild(notice);

                            setTimeout(() => {
                                window.location.reload();
                            }, 5000);
                        }
                    })
                    .catch(error => {
                        console.error('Error restarting server:', error);
                        alert('Failed to restart server. Please try again.');
                    });
            }
        }
    </script>
    {% endblock %}
</head>

<body class="d-flex flex-column vh-100">
    <!-- Early class application to prevent flash of full UI in minimal mode -->
    <script>(function(){var p=new URLSearchParams(window.location.search);if(p.get('minimal')==='true')document.body.setAttribute('data-minimal','true');})();</script>
    <div id="content" class="flex-grow-1">
        {% with messages = get_flashed_messages(with_categories=True) %}
        {% if messages %}
        <ul class="messages list-unstyled text-center rounded col-12 col-md-8 col-lg-6 mx-auto">
            {% for category, message in messages %}
            <li class="alert
                            {% if category == 'error' %} alert-danger {% endif %}
                            {% if category == 'warning' %} alert-warning {% endif %}
                            {% if category == 'info' %} alert-info {% endif %}
                            {% if category == 'success' %} alert-success {% endif %}
                        ">
                {{ message }}
            </li>
            {% endfor %}
        </ul>
        {% endif %}
        {% endwith %}
        {% block content %} {% endblock %}
    </div>

    <div id="bottom-nav" class="bottom-nav">
        <div class="app-title">SyncLyrics</div>
        <nav class="nav-controls">
            <ul class="nav">
                <li class="nav-item">
                    <a class="nav-link {% if request.endpoint == 'index' %} active {% endif %}"
                        href="{{ url_for('index') }}">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if request.endpoint == 'settings_page' %} active {% endif %}"
                        href="{{ url_for('settings_page') }}">Settings</a>
                </li>
                <li class="nav-item">
                    <button class="nav-link" onclick="restartServer()">
                        Restart
                    </button>
                </li>
                <li class="nav-item">
                    <a class="nav-link exit-link" onclick="exitApplication(event)">
                        Exit
                    </a>
                </li>
            </ul>
        </nav>
        <div class="credits">
            <a href="https://github.com/AnshulJ999/SyncLyrics" target="_blank" class="repo-link">
                <img src="{{ url_for('static', filename='images/github.png')}}" alt="Github" class="logo">
                <span>Project</span>
            </a>
        </div>
    </div>
</body>

</html>